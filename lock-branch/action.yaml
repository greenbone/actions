name: "Lock branch action"
author: "Jaspar Stach <jaspar.stach@greenbone.net>"
description: "An action that locks the target branch and prevents pushing on it."

inputs:
  github-token:
    description: "Github user token, that is legitimated to set the lock."
    required: true
  lock:
    description: "Lock or unlock (Options: true, false)? Default: true"
    default: "true"
    required: true
  repository:
    description: "What repository branch should be locked? Defaults to the executing repository."
    default: ${{ github.repository }}
    required: true
  branch:
    description: "Branch that should be locked. Default: main"
    default: "main"
    required: true

branding:
  icon: "package"
  color: "green"

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      id: python
      with:
        python-version: "3.10"
    - name: Virtual Environment
      id: virtualenv
      run: |
        echo "path=${{ github.action_path }}/${{ github.action }}-venv" >> $GITHUB_OUTPUT
        echo "name=${{ github.action }}-venv" >> $GITHUB_OUTPUT
      shell: bash
    - name: Cache Virtual Environment
      id: cache-virtualenv
      uses: actions/cache@v3
      with:
        key: ${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ steps.virtualenv.outputs.name }}
        path: ${{ steps.virtualenv.outputs.path }}
    - name: Create virtual environment
      if: ${{ steps.cache-virtualenv.outputs.cache-hit != 'true' }}
      run: |
        python -m venv ${{ steps.virtualenv.outputs.path }}
      shell: bash
    - name: Install pontos
      run: |
        source ${{ steps.virtualenv.outputs.path }}/bin/activate
        python -m pip install --upgrade pip
        python -m pip install --upgrade pontos
        wget https://github.com/greenbone/pontos/raw/main/scripts/github/lock-branch.py -O ~/lock-branch.py
      shell: bash
    - name: lock/unlock?
      run: |
        if [[ "${{inputs.lock}}" == "true" ]];
        then
          echo "LOCK_OPT=--lock" >> $GITHUB_ENV
        elif [[ "${{inputs.lock}}" == "false" ]];
        then
          echo "LOCK_OPT=--no-lock" >> $GITHUB_ENV
        else
          echo "LOCK_OPT=--no-lock" >> $GITHUB_ENV
        fi
      shell: bash
      # in case of blubber input let the branch be unlocked!
    - name: Prepare release and store the version
      run: |
        source ${{ steps.virtualenv.outputs.path }}/bin/activate
        pontos-github-script ~/lock-branch.py ${{ inputs.repository }} ${{ inputs.branch }} ${{ env.LOCK_OPT }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
