name: "Detect hidden unicode"
description: "Detects hidden unicode in newly committed config files."

branding:
  icon: "package"
  color: "green"

runs:
  using: "composite"
  steps:
    # According to this comment on SO: https://stackoverflow.com/questions/74265821/get-modified-files-in-github-actions
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      with:
        fetch-depth: 1

    # ‚Äçhttps://docs.github.com/en/actions/reference/workflows-and-actions/workflow-commands#example-of-a-multiline-string
    # https://medium.com/@ibraheemabukaff/github-actions-exporting-multi-line-one-line-value-environment-variable-5bb86d01e866
    - name: Store a list of the changed files in this PR
      shell: bash
      run: |
        echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
        echo "$(git diff --name-only HEAD^1 HEAD)" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      with:
        repository: juriku/hidden-characters-detector@1b9032901a872bfd8748afa83907cd8c5dc3c5bb
        path: hidden-characters-detector
        ref: 1b9032901a872bfd8748afa83907cd8c5dc3c5bb # main at 10. September 2025

    - name: Install hidden-characters-detector
      shell: bash
      run: |
        cd hidden-characters-detector
        pip install -r requirements.txt
        chmod +x hidden-characters-detector.py
        cd ..

    - name: Run hidden unicode detector against the list of changed files
      shell: bash
      run: |
        echo "Scan the following files for hidden unicode:"
        echo "${{ env.CHANGED_FILES }}"
        while IFS= read -r line ;
        echo "SCAN START"
        echo "CURRENT FILE: $line"
        do ./hidden-characters-detector/hidden-characters-detector.py -f $line --check-ivs --fail
        echo "SCAN END"
        done <<< "${{ env.CHANGED_FILES }}"
